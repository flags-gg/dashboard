# Base
FROM hub.docker.com/node:23-alpine AS base
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable
RUN apk add --no-cache libc6-compat openssl
RUN corepack install -g pnpm@latest

# Dependencies
FROM base AS deps
WORKDIR /app
COPY package.json pnpm-lock.yaml ./
RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --frozen-lockfile
RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm add sharp

## Copy the files
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

ARG NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
ARG CLERK_SECRET_KEY

ARG FLAGS_DASHBOARD_ENVIRONMENT_ID
ENV NEXT_PUBLIC_FLAGS_PROJECT=b0c5020e-760e-4156-a88b-344fb725a9b7
ENV NEXT_PUBLIC_FLAGS_AGENT=c778cf4b-83f1-4c53-951e-604102c84898
ENV NEXT_PUBLIC_FLAGS_ENVIRONMENT=$FLAGS_DASHBOARD_ENVIRONMENT_ID

RUN SKIP_ENV_VALIDATION=1 NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=$NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY CLERK_SECRET_KEY=$CLERK_SECRET_KEY pnpm build --turbopack

# Runner
FROM base AS runner
WORKDIR /app

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

RUN mkdir .next
RUN chown nextjs:nodejs .next

COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
COPY --from=builder /app/public ./public

## Set Args
ARG GIT_BUILD
ARG GIT_VERSION
ARG SERVICE_NAME

ARG KEYCLOAK_SECRET
ARG KEYCLOAK_ISSUER
ARG KEYCLOAK_ID

ARG FLAGS_DASHBOARD_ENVIRONMENT_ID

ARG UPLOADTHING_TOKEN

ARG NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
ARG CLERK_SECRET_KEY

ARG STRIPE_KEY
ARG STRIPE_SECRET

## Set Envs for build
ENV COMMIT_HASH=$GIT_BUILD
ENV GIT_TAG=$GIT_VERSION
ENV SERVICE_NAME=$SERVICE_NAME
ENV API_SERVER=https://api.flags.gg/v1

ENV NEXT_PUBLIC_FLAGS_PROJECT=b0c5020e-760e-4156-a88b-344fb725a9b7
ENV NEXT_PUBLIC_FLAGS_AGENT=c778cf4b-83f1-4c53-951e-604102c84898
ENV NEXT_PUBLIC_FLAGS_ENVIRONMENT=$FLAGS_DASHBOARD_ENVIRONMENT_ID

ENV UPLOADTHING_TOKEN=$UPLOADTHING_TOKEN

ENV STRIPE_KEY=$STRIPE_KEY
ENV STRIPE_SECRET=$STRIPE_SECRET

ENV NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=$NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
ENV CLERK_SECRET_KEY=$CLERK_SECRET_KEY

RUN echo "COMMIT_HASH=$COMMIT_HASH" >> .env
RUN echo "GIT_TAG=$GIT_TAG" >> .env
RUN echo "SERVICE_NAME=$SERVICE_NAME" >> .env
RUN echo "API_SERVER=https://api.flags.gg/v1" >> .env
RUN echo "NEXT_PUBLIC_FLAGS_PROJECT=$NEXT_PUBLIC_FLAGS_PROJECT" >> .env
RUN echo "NEXT_PUBLIC_FLAGS_AGENT=$NEXT_PUBLIC_FLAGS_AGENT" >> .env
RUN echo "NEXT_PUBLIC_FLAGS_ENVIRONMENT=$NEXT_PUBLIC_FLAGS_ENVIRONMENT" >> .env
RUN echo "UPLOADTHING_TOKEN=$UPLOADTHING_TOKEN" >> .env
RUN echo "STRIPE_KEY=$STRIPE_KEY" >> .env
RUN echo "STRIPE_SECRET=$STRIPE_SECRET" >> .env
RUN echo "NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=$NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY" >> .env
RUN echo "CLERK_SECRET_KEY=$CLERK_SECRET_KEY" >> .env

USER nextjs

EXPOSE 3000
ENV NODE_ENV=production
ENV PORT=3000
CMD ["node", "server.js"]
